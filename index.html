<!DOCTYPE html>
<html>
<head>
    <title>한글 문서 뷰어</title>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
    <script src="https://unpkg.com/cfb/dist/cfb.js"></script>
    <style>
        body {
            font-family: 'Malgun Gothic', 'Segoe UI', sans-serif;
            margin: 20px;
        }
        .file-input {
            margin-bottom: 20px;
        }
        .tab-buttons {
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            cursor: pointer;
            margin-right: 5px;
        }
        .tab-button.active {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        #hwp-container {
            border: 1px solid #ddd;
            padding: 20px;
            min-height: 400px;
            background: white;
        }
        #hwp-text {
            white-space: pre-wrap;
            font-family: 'Malgun Gothic', sans-serif;
        }
        .hwp-page {
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #eee;
            background: white;
        }
    </style>
</head>
<body>
    <h1>한글 문서 뷰어</h1>
    
    <div class="file-input">
        <input type="file" id="hwp-file" accept=".hwp" />
    </div>
    
    <div class="tab-buttons">
        <button class="tab-button active" data-tab="formatted-tab">서식 포함</button>
        <button class="tab-button" data-tab="text-tab">텍스트만</button>
    </div>
    
    <div id="text-tab" class="tab-content">
        <div id="hwp-text"></div>
    </div>
    
    <div id="formatted-tab" class="tab-content active">
        <div id="hwp-container"></div>
    </div>

    <script src="hwpjs.js"></script>
    <script>
        // 탭 전환 기능
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');
            });
        });
        
        // 안전하게 속성에 접근하는 헬퍼 함수
        function safeGet(obj, path, defaultValue = null) {
            if (!obj) return defaultValue;
            
            const keys = path.split('.');
            let current = obj;
            
            for (const key of keys) {
                if (current === null || current === undefined) {
                    return defaultValue;
                }
                current = current[key];
            }
            
            return current === undefined ? defaultValue : current;
        }
        
        // 원본 hwpjs 객체를 수정하여 안전한 버전 생성
        function patchHwpjs(hwpjsObj) {
            // ObjectHwp 함수 안전하게 패치
            const originalObjectHwp = hwpjsObj.ObjectHwp;
            hwpjsObj.ObjectHwp = function() {
                try {
                    // 원래의 함수 호출
                    const result = originalObjectHwp.call(hwpjsObj);
                    return result;
                } catch (error) {
                    console.warn("ObjectHwp 에러 처리:", error);
                    
                    // 빈 결과 반환하는 대신 텍스트만 포함된 단순한 객체 배열 반환
                    const fallbackResult = [];
                    const sections = hwpjsObj.hwp.BodyText.data || [];
                    
                    for (const section of sections) {
                        if (!section.data) continue;
                        
                        const paragraphs = Object.values(section.data).filter(item => 
                            item.name === "HWPTAG_PARA_TEXT"
                        );
                        
                        for (const para of paragraphs) {
                            fallbackResult.push({
                                type: 'paragraph',
                                paragraph: {
                                    text: para.text || "",
                                    start_line: 0
                                }
                            });
                        }
                    }
                    
                    return fallbackResult;
                }
            };
            
            // hwpTable 함수 안전하게 패치
            const originalHwpTable = hwpjsObj.hwpTable;
            hwpjsObj.hwpTable = function(data) {
                try {
                    // table 객체 존재 확인
                    if (!data || !data.table) {
                        console.warn("테이블 데이터가 없습니다");
                        return [document.createElement('div')];
                    }
                    
                    return originalHwpTable.call(hwpjsObj, data);
                } catch (error) {
                    console.warn("hwpTable 에러 처리:", error);
                    
                    // 간단한 div 반환
                    const div = document.createElement('div');
                    div.textContent = "[테이블 렌더링 오류]";
                    return [div];
                }
            };
            
            return hwpjsObj;
        }
        
        // 파일 로드 및 처리
        document.getElementById('hwp-file').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('hwp-container').innerHTML = '문서를 로드하는 중...';
            document.getElementById('hwp-text').textContent = '';
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                
                // hwpjs 객체 생성 및 패치
                const hwp = new hwpjs(arrayBuffer);
                patchHwpjs(hwp);
                
                // 텍스트 추출
                const extractedText = hwp.getText();
                document.getElementById('hwp-text').textContent = extractedText;
                
                try {
                    // 서식 있는 HTML로 변환
                    const formattedHtml = hwp.getHtml();
                    document.getElementById('hwp-container').innerHTML = formattedHtml;
                    
                    // 이미지가 있으면 추가
                    const imageCount = hwp.hwp.ImageCnt || 0;
                    if (imageCount > 0) {
                        for (let i = 0; i < imageCount; i++) {
                            try {
                                const img = hwp.getBinImage(i);
                                document.getElementById('hwp-container').appendChild(img);
                            } catch (imgErr) {
                                console.warn('이미지 처리 오류:', imgErr);
                            }
                        }
                    }
                    
                    console.log('HWP 문서 로드 완료');
                } catch (htmlError) {
                    console.error('HTML 변환 오류:', htmlError);
                    document.getElementById('hwp-container').innerHTML = 
                        `<div style="color:red;padding:20px;">
                            <h3>서식 렌더링에 문제가 발생했습니다.</h3>
                            <p>텍스트 탭에서 내용을 확인하세요.</p>
                        </div>`;
                }
                
            } catch (error) {
                console.error('파일 처리 오류:', error);
                document.getElementById('hwp-container').innerHTML = 
                    `<div style="color:red;padding:20px;">파일 처리 중 오류가 발생했습니다: ${error.message}</div>`;
                document.getElementById('hwp-text').textContent = '파일 처리 중 오류가 발생했습니다.';
            }
        });
        
        // 추가 패치: ObjectHwp 함수 내의 LIST_HEADER 처리 개선
        function patchListHeaderProcessing() {
            const originalScript = document.querySelector('script[src="hwpjs.js"]');
            
            if (originalScript) {
                // 원본 스크립트를 복제하고 수정된 버전 로드
                const newScript = document.createElement('script');
                
                fetch(originalScript.src)
                    .then(response => response.text())
                    .then(scriptContent => {
                        // ObjectHwp 함수 내의 LIST_HEADER 처리 수정
                        scriptContent = scriptContent.replace(
                            /if\(\$\.type === "tbl "\) \{\s*console\.log\('캡션체크', _\.caption\);\s*const cell = _\.cell_attribute;/g,
                            'if($.type === "tbl ") {\n' +
                            '  console.log(\'캡션체크\', _.caption);\n' +
                            '  const cell = _.cell_attribute || {};\n' +
                            '  if(!cell.address) cell.address = {row: 0, col: 0};\n' +
                            '  if(!cell.span) cell.span = {row: 1, col: 1};\n' +
                            '  if(!cell.cell) cell.cell = {width: 0, height: 0};'
                        );
                        
                        // ObjectHwp 함수 내의 테이블 속성 접근 개선
                        scriptContent = scriptContent.replace(
                            /\$\.table\[cnt\.row\]\[cnt\.col\] = \{/g,
                            'if(!$.table[cnt.row]) $.table[cnt.row] = [];\n' +
                            '  if(!$.table[cnt.row][cnt.col]) $.table[cnt.row][cnt.col] = {};\n' +
                            '  $.table[cnt.row][cnt.col] = {'
                        );
                        
                        const blob = new Blob([scriptContent], {type: 'application/javascript'});
                        newScript.src = URL.createObjectURL(blob);
                        
                        newScript.onload = () => {
                            console.log('hwpjs 패치 적용 완료');
                        };
                        
                        document.head.appendChild(newScript);
                    })
                    .catch(err => {
                        console.error('스크립트 패치 실패:', err);
                    });
            }
        }
        
        // 페이지 로드 시 패치 시도
        window.addEventListener('load', patchListHeaderProcessing);
    </script>
</body>
</html>
